document.addEventListener("DOMContentLoaded",J);const e="https://gist.githubusercontent.com/Thomas-Marchand/427d44e917d26d6073378d81db84d5b2/raw/calendar_events.json",t=6,n=21,o=60,s={M1:"#4243a6",M2:"#eb0909",M1_ANDROIDE:"#ba0c50",M2_ANDROIDE:"#bf1e9a",M2_BIM:"#86c7ac",M2_DAC:"#4c3553",M2_IMA:"#2c2785"},a=24,l=768;let i,c,d,r,u=[],m={},p=[],g={},y=0,f=[],h="daily",v=0,w=!1;const E=document.getElementById("sidebar"),L=document.getElementById("sidebar-toggle-btn"),k=document.querySelector(".calendar-container"),I=document.getElementById("today-btn"),D=document.getElementById("daily-view-btn"),b=document.getElementById("weekly-view-btn"),M=document.getElementById("prev-btn"),x=document.getElementById("next-btn"),$=document.getElementById("last-updated"),C=document.getElementById("collapsed-sidebar-info"),S=document.getElementById("instruction-popup-overlay"),B=document.getElementById("instruction-popup-box"),N=document.getElementById("instruction-popup-close-btn"),T=document.getElementById("stale-popup-overlay"),A=document.getElementById("stale-popup-box"),H=document.getElementById("stale-popup-close-btn"),O=document.getElementById("event-detail-overlay"),j=document.getElementById("event-detail-box"),P=document.getElementById("event-detail-close-btn"),q=document.getElementById("event-detail-title"),_=document.getElementById("event-detail-group"),G=document.getElementById("event-detail-date"),V=document.getElementById("event-detail-time"),W=document.getElementById("event-detail-location");async function J(){I.addEventListener("click",Me),M.addEventListener("click",be),x.addEventListener("click",De),L.addEventListener("click",ge),D.addEventListener("click",()=>ce("daily")),b.addEventListener("click",()=>ce("weekly")),T.addEventListener("click",fe),A.addEventListener("click",e=>e.stopPropagation()),H.addEventListener("click",fe),P.addEventListener("click",we),O.addEventListener("click",we),j.addEventListener("click",e=>e.stopPropagation()),S.addEventListener("click",he),B.addEventListener("click",e=>e.stopPropagation()),N.addEventListener("click",he),k.addEventListener("touchstart",de,!1),k.addEventListener("touchend",re,!1),document.addEventListener("keydown",ue),X(),U();try{const t=await oe(e);u=t.events,g=t.meta,document.getElementById("loading-indicator").style.display="none";const n=g.c;n&&Array.isArray(n)&&u.forEach(e=>{e.g=n[e.g]}),K(),se(),ae(),le(),ie(),localStorage.getItem("calendarVisited")||S.classList.remove("hidden")}catch(e){document.getElementById("loading-indicator").innerText="Failed to load calendar data.",console.error("Failed to initialize calendar:",e)}}function R(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function F(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);const n=(16777215&t).toString(16).toUpperCase();return"#"+"00000".substring(0,6-n.length)+n}function Y(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}function z(e){if("string"!=typeof e||!e.includes(":"))return null;const[t,n]=e.split(":").map(Number);return 60*t+n}function X(){"true"===localStorage.getItem("sidebarCollapsed")&&E.classList.add("collapsed")}function U(){"weekly"===localStorage.getItem("calendarView")&&(h="weekly"),Q()}function K(){const e=document.getElementById("group-list");f=[...g.c].sort();const t=JSON.parse(localStorage.getItem("selectedGroups"));p=t||["M2"],t||localStorage.setItem("selectedGroups",JSON.stringify(p)),f.forEach(t=>{m[t]=s[t]||F(t);const n=document.createElement("button");n.className="group-btn",n.textContent=t,n.dataset.group=t,n.style.backgroundColor=m[t],p.includes(t)||n.classList.add("inactive"),n.addEventListener("click",()=>{n.classList.toggle("inactive");const e=n.dataset.group;n.classList.contains("inactive")?p=p.filter(t=>t!==e):p.push(e),localStorage.setItem("selectedGroups",JSON.stringify(p)),ee(),se()}),e.appendChild(n)}),ee()}function Q(){"weekly"===h?(b.classList.add("active"),D.classList.remove("active")):(D.classList.add("active"),b.classList.remove("active"))}function Z(){const e=7*(g.w-1);M.disabled=y<=0,x.disabled=y>=e;const t="weekly"===h?"Week":"Days";M.title=`Previous ${t} (←)`,x.title=`Next ${t} (→)`}function ee(){const e=document.getElementById("group-color-indicators");e.innerHTML="",f.forEach(t=>{const n=document.createElement("div");if(p.includes(t)){n.className="color-indicator";const e=m[t]||"#ccc";n.style.backgroundColor=e,n.style.setProperty("--glow-color",Y(e,.7))}else n.className="color-indicator inactive";e.appendChild(n)})}function te(){document.querySelectorAll(".current-time-line").forEach(e=>e.remove());const e=new Date,t=R(e),n=document.querySelector(`.day-column[data-date='${t}'] .timeline`);if(!n)return;const o=60*e.getHours()+e.getMinutes();if(o<360||o>1260)return;const s=(o-360)/60*Le(),a=document.createElement("div");a.className="current-time-line",a.style.top=`${s}px`,n.appendChild(a)}function ne(e,t){const n="weekly"===h&&window.innerWidth<l,o={weekday:n?void 0:"short",month:n?"numeric":"short",day:"numeric"};e.textContent=t.toLocaleDateString(void 0,o);const s=R(new Date);R(t)===s&&e.classList.add("today-header")}async function oe(e){const t=await fetch(`${e}?t=${(new Date).getTime()}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}function se(){k.innerHTML="",k.classList.toggle("weekly-view","weekly"===h);const e="weekly"===h?6:2,t=new Date;t.setDate(t.getDate()+y);let n=new Date(t);if("weekly"===h){const e=n.getDay(),t=n.getDate()-e+(0===e?-6:1);n.setDate(t)}for(let t=0;t<e;t++){const e=new Date(n);e.setDate(e.getDate()+t);const o=R(e),s=document.createElement("div");s.className="day-column",s.dataset.date=o;const a=document.createElement("div");a.className="day-header",ne(a,e);const l=document.createElement("div");l.className="timeline",ke(l),s.appendChild(a),s.appendChild(l),k.appendChild(s);Ie(u.filter(e=>{const t=e.sd.split("/").reverse().join("-");return p.includes(e.g)&&t===o}),l)}Z(),te()}function ae(){const e=()=>{if(!g.ts)return;const e=new Date(g.ts),t=new Date,n=Math.round((t-e)/6e4);let o="";if(n<1)o="Last update: just now";else if(n<60)o=`Last update: ${n} minute${n>1?"s":""} ago`;else{const e=Math.floor(n/60);o=`Last update: ${e} hour${e>1?"s":""} ago`}$.textContent=o,C.textContent=o,Ee()};e(),i&&clearInterval(i),i=setInterval(e,6e4)}function le(){te(),c&&clearInterval(c),c=setInterval(te,6e4)}function ie(){const e=document.querySelector(".current-time-line");if(!e)return;const t=document.querySelector(".calendar-container"),n=e.offsetTop,o=t.clientHeight;n>t.scrollTop+o-50&&e.scrollIntoView({behavior:"smooth",block:"center"})}function ce(e){if(e===h)return;const t=new Date;t.setHours(0,0,0,0);const n=7*(g.w-1);let o=y;if("weekly"===e){const e=new Date;e.setDate(e.getDate()+y),e.setHours(0,0,0,0);const n=e.getDay(),s=e.getDate()-n+(0===n?-6:1),a=new Date(e.setDate(s));o=Math.round((a-t)/864e5)}else if("daily"===e){const e=new Date;e.setDate(e.getDate()+y);const n=e.getDay(),s=e.getDate()-n+(0===n?-6:1),a=new Date(e.setDate(s));let l=new Date(a);const i=[];for(let e=0;e<6;e++){const t=new Date(a);t.setDate(t.getDate()+e),i.push(t.toISOString().split("T")[0].split("-").reverse().join("/"))}const c=u.filter(e=>p.includes(e.g)&&i.includes(e.sd)).sort((e,t)=>e.sd.split("/").reverse().join("-").localeCompare(t.sd.split("/").reverse().join("-")));if(c.length>0){const[e,t,n]=c[0].sd.split("/");l=new Date(n,t-1,e)}o=Math.round((l-t)/864e5)}y=Math.max(0,Math.min(o,n)),h=e,localStorage.setItem("calendarView",e),Q(),se()}function de(e){const t=e.touches[0];d=t.clientX,r=t.clientY,v=(new Date).getTime()}function re(e){const t=e.changedTouches[0],n=t.clientX,o=t.clientY,s=(new Date).getTime()-v,a=n-d,l=o-r;Math.abs(a)>.7*Math.abs(l)&&s<700&&Math.abs(a)>40&&(a<0?x.disabled||(De(),pe()):M.disabled||(be(),pe()))}function ue(e){if("ArrowRight"===e.key)x.disabled||(De(),pe());else if("ArrowLeft"===e.key)M.disabled||(be(),pe());else if("d"===e.key||"D"===e.key)ce("daily");else if("w"===e.key||"W"===e.key)ce("weekly");else if("Tab"===e.key)e.preventDefault(),ge();else if(" "===e.key)e.preventDefault(),Me();else if("Escape"===e.key)fe(),we(),he();else if(e.key>="1"&&e.key<="9"){me(parseInt(e.key)-1)}}function me(e){const t=f[e],n=document.querySelector(`[data-group="${t}"]`);n&&(n.classList.toggle("inactive"),n.classList.contains("inactive")?p=p.filter(e=>e!==t):p.push(t),localStorage.setItem("selectedGroups",JSON.stringify(p)),ee(),se())}function pe(){const e=document.querySelectorAll(".day-header");e.forEach(e=>{e.classList.add("swiped")}),setTimeout(()=>{e.forEach(e=>{e.classList.remove("swiped")})},200)}function ge(){E.classList.toggle("collapsed"),localStorage.setItem("sidebarCollapsed",E.classList.contains("collapsed"))}function ye(){T.classList.remove("hidden")}function fe(){T.classList.add("hidden")}function he(){S.classList.add("hidden"),localStorage.setItem("calendarVisited","true")}function ve(e,t){if(!e)return;const[n,o,s]=e.sd.split("/"),a=new Date(s,o-1,n);q.textContent=e.t,_.textContent=`Group: ${e.g}`,G.textContent=a.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),V.textContent=`${e.st} - ${e.et}`,W.textContent=e.l||"No location specified";const l=m[e.g]||"#888";if(j.style.borderTopColor=l,_.style.color=l,t){const e=t.getBoundingClientRect(),n=320,o=200;let s=e.right+10,a=e.top;s+n>window.innerWidth&&(s=e.left-n-10),s<10&&(s=10),a+o>window.innerHeight&&(a=window.innerHeight-o-10),a<10&&(a=10),j.style.left=`${s}px`,j.style.top=`${a}px`}O.classList.remove("hidden")}function we(){O.classList.add("hidden")}function Ee(){if(!g.ts)return;const e=new Date(g.ts);(new Date-e)/36e5>a?($.classList.add("stale-data"),C.classList.add("stale-data"),w||(ye(),w=!0)):($.classList.remove("stale-data"),C.classList.remove("stale-data"),w=!1)}function Le(){const e=window.innerHeight-41;return Math.max(o,e/15)}function ke(e){const t=Le(),o=15*t;e.style.height=`${o}px`;for(let o=6;o<=n;o++){const s=(o-6)*t,a=document.createElement("div");if(a.className="hour-line",a.style.top=`${s}px`,e.appendChild(a),o>6&&o<n){const t=document.createElement("div");t.className="hour-label",t.textContent=`${o}:00`,t.style.top=`${s}px`,e.appendChild(t)}}}function Ie(e,t){if(!e.length)return;const n=Le(),o=e.map(e=>{const t=z(e.st),o=z(e.et);return null===t||null===o||o<=t?null:{...e,startMinutes:t,endMinutes:o,top:(t-360)/60*n,height:(o-t)/60*n}}).filter(Boolean).sort((e,t)=>e.startMinutes-t.startMinutes),s=[];if(o.length>0){let e=[o[0]];s.push(e);let t=o[0].endMinutes;for(let n=1;n<o.length;n++){const a=o[n];a.startMinutes>=t?(e=[a],s.push(e),t=a.endMinutes):(e.push(a),t=Math.max(t,a.endMinutes))}}for(const e of s){e.sort((e,t)=>e.startMinutes-t.startMinutes);const t=[];for(const n of e){let e=!1;for(const o of t)if(n.startMinutes>=o[o.length-1].endMinutes){o.push(n),n.colIndex=t.indexOf(o),e=!0;break}e||(t.push([n]),n.colIndex=t.length-1)}for(const n of e)n.totalColumns=t.length}for(const e of o){const n=document.createElement("div");n.className="event-block";const o=100/e.totalColumns;n.style.width=`calc(${o}% - 5px)`,n.style.left=e.colIndex*o+"%",n.style.top=`${e.top}px`,n.style.height=`${Math.max(20,e.height-2)}px`;const s=m[e.g]||"#ccc";n.style.backgroundColor=Y(s,.5),n.style.borderColor=s,n.style.setProperty("--glow-color",Y(s,.7));if("weekly"===h&&window.innerWidth<l){const t=(e.l||"N/A").split("").join("<br>");n.innerHTML=`<p class="event-title">${t}</p>`,n.style.fontSize="10px",n.style.lineHeight="1.1",n.style.textAlign="center",n.style.padding="4px 2px"}else n.innerHTML=`<p class="event-title">${e.t}</p><p>${e.st} - ${e.et}</p><p>${e.l}</p>`;n.addEventListener("click",t=>{t.stopPropagation(),ve(e,n)}),t.appendChild(n)}}function De(){y+="weekly"===h?7:2,se()}function be(){y-="weekly"===h?7:2,se()}function Me(){y=0,se(),ie()}