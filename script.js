document.addEventListener("DOMContentLoaded",Q);const e="https://gist.githubusercontent.com/Thomas-Marchand/427d44e917d26d6073378d81db84d5b2/raw/",t=`${e}calendar_events.json`,n=`${e}calendar_events_future.json`,s=6,o=21,a=60,i={M1:"#4243a6",M2:"#eb0909",M1_ANDROIDE:"#ba0c50",M2_ANDROIDE:"#bf1e9a",M2_BIM:"#86c7ac",M2_DAC:"#4c3553",M2_IMA:"#2c2785"},c=24,l=768;let d,r,u,g,m=[],f={},p=[],y={},h=0,v=!1,w=!1,E=0,D="",L=[],b="daily",k=0,I=!1;const M=document.getElementById("sidebar"),$=document.getElementById("sidebar-toggle-btn"),x=document.querySelector(".calendar-container"),S=document.getElementById("today-btn"),C=document.getElementById("daily-view-btn"),B=document.getElementById("weekly-view-btn"),N=document.getElementById("prev-btn"),T=document.getElementById("next-btn"),H=document.getElementById("last-updated"),O=document.getElementById("collapsed-sidebar-info"),j=document.getElementById("instruction-popup-overlay"),A=document.getElementById("instruction-popup-box"),_=document.getElementById("instruction-popup-close-btn"),P=document.getElementById("stale-popup-overlay"),q=document.getElementById("stale-popup-box"),F=document.getElementById("stale-popup-close-btn"),R=document.getElementById("event-detail-overlay"),G=document.getElementById("event-detail-box"),V=document.getElementById("event-detail-close-btn"),W=document.getElementById("event-detail-title"),J=document.getElementById("event-detail-group"),Y=document.getElementById("event-detail-date"),z=document.getElementById("event-detail-time"),X=document.getElementById("event-detail-location");async function Q(){D=T.innerHTML,S.addEventListener("click",_e),N.addEventListener("click",Ae),T.addEventListener("click",je),$.addEventListener("click",Me),C.addEventListener("click",()=>Ee("daily")),B.addEventListener("click",()=>Ee("weekly")),P.addEventListener("click",xe),q.addEventListener("click",e=>e.stopPropagation()),F.addEventListener("click",xe),V.addEventListener("click",Be),R.addEventListener("click",Be),G.addEventListener("click",e=>e.stopPropagation()),j.addEventListener("click",Se),A.addEventListener("click",e=>e.stopPropagation()),_.addEventListener("click",Se),x.addEventListener("touchstart",De,!1),x.addEventListener("touchend",Le,!1),document.addEventListener("keydown",be),oe(),ae();try{await ge(),document.getElementById("loading-indicator").style.display="none",maxDateOffset=7*(y.w-1),ie(),ye(),he(),ve(),we(),localStorage.getItem("calendarVisited")||j.classList.remove("hidden")}catch(e){document.getElementById("loading-indicator").innerText="Failed to load calendar data.",console.error("Failed to initialize calendar:",e)}}function U(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function K(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);const n=(16777215&t).toString(16).toUpperCase();return"#"+"00000".substring(0,6-n.length)+n}function Z(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}function ee(e){if("string"!=typeof e||!e.includes(":"))return null;const[t,n]=e.split(":").map(Number);return 60*t+n}function te(e){const t=String(e).padStart(6,"0");return`${t.substring(0,2)}/${t.substring(2,4)}/${"20"+t.substring(4,6)}`}function ne(e){const t=String(e).padStart(4,"0");return`${t.substring(0,2)}:${t.substring(2,4)}`}function se(e){const{schema:t,events:n,meta:s}=e,o=s.c,a={};return t.forEach((e,t)=>{a[e]=t}),n.map(e=>{const t={sd:te(e[a.d]),st:ne(e[a.st]),et:ne(e[a.et]),g:o[e[a.g]],t:e[a.t],l:e[a.l]};return a.ed<e.length?t.ed=te(e[a.ed]):t.ed=t.sd,t})}function oe(){"true"===localStorage.getItem("sidebarCollapsed")&&M.classList.add("collapsed")}function ae(){"weekly"===localStorage.getItem("calendarView")&&(b="weekly"),ce()}function ie(){const e=document.getElementById("group-list");L=[...y.c].sort();const t=JSON.parse(localStorage.getItem("selectedGroups"));p=t||["M2"],t||localStorage.setItem("selectedGroups",JSON.stringify(p)),L.forEach(t=>{f[t]=i[t]||K(t);const n=document.createElement("button");n.className="group-btn",n.textContent=t,n.dataset.group=t,n.style.backgroundColor=f[t],p.includes(t)||n.classList.add("inactive"),n.addEventListener("click",()=>{n.classList.toggle("inactive");const e=n.dataset.group;n.classList.contains("inactive")?p=p.filter(t=>t!==e):p.push(e),localStorage.setItem("selectedGroups",JSON.stringify(p)),de(),ye()}),e.appendChild(n)}),de()}function ce(){"weekly"===b?(B.classList.add("active"),C.classList.remove("active")):(C.classList.add("active"),B.classList.remove("active"))}function le(){N.disabled=h<=0;const e=!v;T.disabled=h>=maxDateOffset&&!e;const t="weekly"===b?"Week":"Days";N.title=`Previous ${t} (←)`,T.title=`Next ${t} (→)`}function de(){const e=document.getElementById("group-color-indicators");e.innerHTML="",L.forEach(t=>{const n=document.createElement("div");if(p.includes(t)){n.className="color-indicator";const e=f[t]||"#ccc";n.style.backgroundColor=e,n.style.setProperty("--glow-color",Z(e,.7))}else n.className="color-indicator inactive";e.appendChild(n)})}function re(){document.querySelectorAll(".current-time-line").forEach(e=>e.remove());const e=new Date,t=U(e),n=document.querySelector(`.day-column[data-date='${t}'] .timeline`);if(!n)return;const s=60*e.getHours()+e.getMinutes();if(s<360||s>1260)return;const o=(s-360)/60*Te(),a=document.createElement("div");a.className="current-time-line",a.style.top=`${o}px`,n.appendChild(a)}function ue(e,t){const n="weekly"===b&&window.innerWidth<l,s={weekday:n?void 0:"short",month:n?"numeric":"short",day:"numeric"};e.textContent=t.toLocaleDateString(void 0,s);const o=U(new Date);U(t)===o&&e.classList.add("today-header")}async function ge(){const e=await me(t);m=se(e),y=e.meta}async function me(e){const t=await fetch(`${e}?t=${(new Date).getTime()}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}async function fe(){if(!v&&!w){w=!0,T.innerHTML="⏳",T.disabled=!0,console.log("Fetching future calendar data...");try{const e=se(await me(n));if(e.length>0){m=m.concat(e);const t=m.reduce((e,t)=>{const n=new Date(e.sd.split("/").reverse().join("-"));return new Date(t.sd.split("/").reverse().join("-"))>n?t:e}),n=new Date;n.setHours(0,0,0,0);const s=new Date(t.sd.split("/").reverse().join("-"));maxDateOffset=Math.floor((s-n)/864e5),console.log(`Future data loaded. New max offset: ${maxDateOffset} days.`)}v=!0}catch(e){console.error("Failed to load future calendar data:",e)}finally{w=!1,T.innerHTML=D}}}async function pe(){console.log("Refreshing all calendar data...");try{if(await ge(),v){console.log("Re-fetching future data to stay in sync...");const e=se(await me(n));m=m.concat(e)}}catch(e){console.error("Failed to refresh calendar data:",e)}finally{ye(),he(),re()}}function ye(){x.innerHTML="",x.classList.toggle("weekly-view","weekly"===b);const e="weekly"===b?6:2,t=new Date;t.setDate(t.getDate()+h);let n=new Date(t);if("weekly"===b){const e=n.getDay();if(0===e&&0===h){const e=n.getDate()+1;n.setDate(e)}else{const t=n.getDate()-e+(0===e?-6:1);n.setDate(t)}}for(let t=0;t<e;t++){const e=new Date(n);e.setDate(e.getDate()+t);const s=U(e),o=document.createElement("div");o.className="day-column",o.dataset.date=s;const a=document.createElement("div");a.className="day-header",ue(a,e);const i=document.createElement("div");i.className="timeline",He(i),o.appendChild(a),o.appendChild(i),x.appendChild(o);Oe(m.filter(e=>{const t=e.sd.split("/").reverse().join("-");return p.includes(e.g)&&t===s}),i)}le(),re()}function he(){const e=()=>{if(!y.ts)return;const e=new Date(y.ts),t=new Date,n=Math.round((t-e)/6e4);let s="";if(n<1)s="Last update: just now";else if(n<60)s=`Last update: ${n} minute${n>1?"s":""} ago`;else{const e=Math.floor(n/60);s=`Last update: ${e} hour${e>1?"s":""} ago`}H.textContent=s,O.textContent=s,Ne()};e(),d&&clearInterval(d),d=setInterval(e,6e4)}function ve(){re(),r&&clearInterval(r),r=setInterval(re,6e4)}function we(){const e=document.querySelector(".current-time-line");if(!e)return;const t=document.querySelector(".calendar-container"),n=e.offsetTop,s=t.clientHeight;n>t.scrollTop+s-50&&e.scrollIntoView({behavior:"smooth",block:"center"})}function Ee(e){if(e===b)return;const t=new Date;t.setHours(0,0,0,0);const n=7*(y.w-1);let s=h;if("weekly"===e){const e=new Date;e.setDate(e.getDate()+h),e.setHours(0,0,0,0);const n=e.getDay(),o=e.getDate()-n+(0===n?-6:1),a=new Date(e.setDate(o));s=Math.round((a-t)/864e5)}else if("daily"===e){const e=new Date;e.setDate(e.getDate()+h);const n=e.getDay(),o=e.getDate()-n+(0===n?-6:1),a=new Date(e.setDate(o));let i=new Date(a);const c=[];for(let e=0;e<6;e++){const t=new Date(a);t.setDate(t.getDate()+e),c.push(t.toISOString().split("T")[0].split("-").reverse().join("/"))}const l=m.filter(e=>p.includes(e.g)&&c.includes(e.sd)).sort((e,t)=>e.sd.split("/").reverse().join("-").localeCompare(t.sd.split("/").reverse().join("-")));if(l.length>0){const[e,t,n]=l[0].sd.split("/");i=new Date(n,t-1,e)}s=Math.round((i-t)/864e5)}h=Math.max(0,Math.min(s,n)),b=e,localStorage.setItem("calendarView",e),ce(),ye()}function De(e){const t=e.touches[0];u=t.clientX,g=t.clientY,k=(new Date).getTime()}function Le(e){const t=e.changedTouches[0],n=t.clientX,s=t.clientY,o=(new Date).getTime()-k,a=n-u,i=s-g;Math.abs(a)>.7*Math.abs(i)&&o<700&&Math.abs(a)>40&&(a<0?T.disabled||(je(),Ie()):N.disabled||(Ae(),Ie()))}function be(e){if("ArrowRight"===e.key)T.disabled||(je(),Ie());else if("ArrowLeft"===e.key)N.disabled||(Ae(),Ie());else if("d"===e.key||"D"===e.key)Ee("daily");else if("w"===e.key||"W"===e.key)Ee("weekly");else if("Tab"===e.key)e.preventDefault(),Me();else if(" "===e.key)e.preventDefault(),_e();else if("Escape"===e.key)xe(),Be(),Se();else if(e.key>="1"&&e.key<="9"){ke(parseInt(e.key)-1)}}function ke(e){const t=L[e],n=document.querySelector(`[data-group="${t}"]`);n&&(n.classList.toggle("inactive"),n.classList.contains("inactive")?p=p.filter(e=>e!==t):p.push(t),localStorage.setItem("selectedGroups",JSON.stringify(p)),de(),ye())}function Ie(){const e=document.querySelectorAll(".day-header");e.forEach(e=>{e.classList.add("swiped")}),setTimeout(()=>{e.forEach(e=>{e.classList.remove("swiped")})},200)}function Me(){M.classList.toggle("collapsed"),localStorage.setItem("sidebarCollapsed",M.classList.contains("collapsed"))}function $e(){P.classList.remove("hidden")}function xe(){P.classList.add("hidden")}function Se(){j.classList.add("hidden"),localStorage.setItem("calendarVisited","true")}function Ce(e,t){if(!e)return;const[n,s,o]=e.sd.split("/"),a=new Date(o,s-1,n);W.textContent=e.t,J.textContent=`Group: ${e.g}`,Y.textContent=a.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),z.textContent=`${e.st} - ${e.et}`,X.textContent=e.l||"No location specified";const i=f[e.g]||"#888";if(G.style.borderTopColor=i,J.style.color=i,t){const e=t.getBoundingClientRect(),n=320,s=200;let o=e.right+10,a=e.top;o+n>window.innerWidth&&(o=e.left-n-10),o<10&&(o=10),a+s>window.innerHeight&&(a=window.innerHeight-s-10),a<10&&(a=10),G.style.left=`${o}px`,G.style.top=`${a}px`}R.classList.remove("hidden")}function Be(){R.classList.add("hidden")}function Ne(){if(!y.ts)return;const e=new Date(y.ts);(new Date-e)/36e5>c?(H.classList.add("stale-data"),O.classList.add("stale-data"),I||($e(),I=!0)):(H.classList.remove("stale-data"),O.classList.remove("stale-data"),I=!1)}function Te(){const e=window.innerHeight-41;return Math.max(a,e/15)}function He(e){const t=Te(),n=15*t;e.style.height=`${n}px`;for(let n=6;n<=o;n++){const s=(n-6)*t,a=document.createElement("div");if(a.className="hour-line",a.style.top=`${s}px`,e.appendChild(a),n>6&&n<o){const t=document.createElement("div");t.className="hour-label",t.textContent=`${n}:00`,t.style.top=`${s}px`,e.appendChild(t)}}}function Oe(e,t){if(!e.length)return;const n=Te(),s=e.map(e=>{const t=ee(e.st),s=ee(e.et);return null===t||null===s||s<=t?null:{...e,startMinutes:t,endMinutes:s,top:(t-360)/60*n,height:(s-t)/60*n}}).filter(Boolean).sort((e,t)=>e.startMinutes-t.startMinutes),o=[];if(s.length>0){let e=[s[0]];o.push(e);let t=s[0].endMinutes;for(let n=1;n<s.length;n++){const a=s[n];a.startMinutes>=t?(e=[a],o.push(e),t=a.endMinutes):(e.push(a),t=Math.max(t,a.endMinutes))}}for(const e of o){e.sort((e,t)=>e.startMinutes-t.startMinutes);const t=[];for(const n of e){let e=!1;for(const s of t)if(n.startMinutes>=s[s.length-1].endMinutes){s.push(n),n.colIndex=t.indexOf(s),e=!0;break}e||(t.push([n]),n.colIndex=t.length-1)}for(const n of e)n.totalColumns=t.length}for(const e of s){const n=document.createElement("div");n.className="event-block";const s=100/e.totalColumns;n.style.width=`calc(${s}% - 5px)`,n.style.left=e.colIndex*s+"%",n.style.top=`${e.top}px`,n.style.height=`${Math.max(20,e.height-2)}px`;const o=f[e.g]||"#ccc";n.style.backgroundColor=Z(o,.5),n.style.borderColor=o,n.style.setProperty("--glow-color",Z(o,.7));if("weekly"===b&&window.innerWidth<l){const t=(e.l||"N/A").split("").join("<br>");n.innerHTML=`<p class="event-title">${t}</p>`,n.style.fontSize="10px",n.style.lineHeight="1.1",n.style.textAlign="center",n.style.padding="4px 2px"}else n.innerHTML=`<p class="event-title">${e.t}</p><p>${e.st} - ${e.et}</p><p>${e.l}</p>`;n.addEventListener("click",t=>{t.stopPropagation(),Ce(e,n)}),t.appendChild(n)}}async function je(){const e="weekly"===b?7:2;h+e>=maxDateOffset&&!v&&await fe(),h+=e,ye()}function Ae(){h-="weekly"===b?7:2,ye()}function _e(){h=0,ye(),we()}document.addEventListener("visibilitychange",async function(){"visible"===document.visibilityState&&await pe()});